---
title: "p8105_hw5_nc2710"
author: "Nicole Comfort"
date: "11/8/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

devtools::install_github("thomasp85/patchwork")

library(tidyverse)
library(ggplot2)
library(ggridges)
library(readxl)
library(dplyr)
library(janitor)
library(patchwork)
library(viridis)
library(rvest)
library(purrr)
library(stringr) 

# set options for figures
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "95%"
)

theme_set(theme_bw() + theme(legend.position = "bottom"))
```

## Problem 1 

The hw5_data zip file contains data from a longitudinal study that included a control arm and an experimental arm. Data for each participant is included in a separate file, and file names include the subject ID and arm (10 subjects per arm). 

The code below creates a tidy dataframe containing data from all participants, including the subject ID, arm, and observations over time (8 weeks): 

```{r import and tidy data}

# create vector of file names to load using the list.files function 
file_name <- list.files(path = "./data") %>% 
  purrr::set_names()

# Iterate over file names and read in data for each subject using purrr::map and saving the result as a new variable in the dataframe
# Tidy the result; manipulate file names to include control arm and subject ID
import_data = function(x) {
  
  df = read_csv(file = str_c("./data/", x)) %>% 
    mutate(filename = x) %>% # adds col with file name
    separate(filename, into = c("file", "remove"), sep = "\\.") %>% # remove .csv from file col
    select(-remove) %>% 
    separate(file, into = c("arm", "subject_id"), sep = "_") # separate file col into arm and subj id variables
  df
  
}

# Run the load_data function on all file names saved in the filename_vector, save output as a list col in a new df called final_df
final_df = 
  tibble(file_name) %>% 
    mutate(data = map(file_name, import_data)) %>% 
      unnest()

# Make sure weekly observations are “tidy” (i.e. long format) and do any other tidying that’s necessary
final_df =
  final_df %>% 
    gather(key = week, value = observation, week_1:week_8) %>% 
    separate(week, into = c("remove", "week"), sep = "_") %>%
    select(-remove) %>% 
    mutate(arm = str_replace(arm, "con", "Control"),
           arm = str_replace(arm, "exp", "Experimental")) %>% 
    mutate(week = as.numeric(week))

```

The raw data includes 20 files (one for each subject with 10 control subjects and 10 experimental subjects), each with eight weeks of observations. I changed this from wide to long format. This results in a final dataset (named final_df) that includes `r nrow(final_df)` observations of `r ncol(final_df)` variables, including: the filename, study arm, subject ID, week of observation, and value of the observation recorded. 

The code below creates a spaghetti plot showing observations of each subject over time:

```{r spaghetti plot}

final_df %>% 
  ggplot(aes(x = week, y = observation, color = subject_id)) +
  geom_line() +
  facet_grid(~arm) +
  labs(
    title = "Observations Across Weeks by Study Arm",
    x = "Week",
    y = "Observation Value"
  )

```

Looking at the spaghetti plot, it is apparent that subjects in the experimental arm had increased values over time compared to subjects in the control group, whose observations seemed to remain relatively stable over time. Also, it looks like the subjects allocated to the experimental group had greater variability in their baseline values than the control subjects.  

## Problem 2 

The Washington Post has gathered data on homicides in 50 large U.S. cities and made the data available through a GitHub repository. The code below loads the raw data: 

```{r import homicide data}

homicide_data =
  read_csv(file = "./homicide-data/homicide-data.csv") # import dataset

```

The raw data is a dataframe regarding homicides composed of `r nrow(homicide_data)` observations of `r ncol(homicide_data)` variables. The variables include: unique case ID, reported date, victim last name and first name, as well as demographic information of the victim (race, age, sex). There is also information on the location including city, state, latitude/longitude, and finally, the disposition of the case (e.g. whether or not the case was resolved). 

We will perform some data manipulation to create a new variable indicating both city and state, and for each city/state, obtain the total number of homicides as well as the number of unsolved homicides: 

```{r data manipulation}

homicide_data = 
  homicide_data %>% 
  janitor::clean_names() %>% # clean names
  mutate(city_state = str_c(city, state, sep = ", ", collapse = NULL)) %>% # create a city_state variable (e.g. “Baltimore, MD”)
  group_by(city_state, disposition) %>% 
  summarize(num_homicides = n()) %>% 
  summarize(total_homicides = sum(num_homicides), # summarize within cities to obtain total # of homicides
            unsolved_homicides = sum(num_homicides[disposition == "Closed without arrest" | disposition == "Open/No arrest"])) # summarize within cities to obtain # of unsolved homicides (those for which the disposition is “Closed without arrest” or “Open/No arrest”).

```


For the city of Baltimore, MD, use the prop.test function to estimate the proportion of homicides that are unsolved; save the output of prop.test as an R object, apply the broom::tidy to this object and pull the estimated proportion and confidence intervals from the resulting tidy dataframe.

```{r prop.test}



```

Now run prop.test for each of the cities in your dataset, and extract both the proportion of unsolved homicides and the confidence interval for each. Do this within a “tidy” pipeline, making use of purrr::map, purrr::map2, list columns and unnest as necessary to create a tidy dataframe with estimated proportions and CIs for each city.

```{r unsolved homicides}

```

Create a plot that shows the estimates and CIs for each city – check out geom_errorbar for a way to add error bars based on the upper and lower limits. Organize cities according to the proportion of unsolved homicides.

```{r homicide plot}



```

